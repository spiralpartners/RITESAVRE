<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>スプリントバーンダウンチャート</title>

	<link rel="stylesheet" type="text/css" href="css/default.css" />

    <script type="text/javascript" src="https://www.google.com/jsapi"></script>

	<script type='text/javascript' src='dwr/engine.js'></script>
	<script type='text/javascript' src='dwr/interface/BurnDownChartController.js'></script>
	<script type='text/javascript' src='dwr/interface/DisplayAssignmentListController.js'></script>

	<script type="text/javascript" src="js/jquery-1.7.2.min.js"></script>
</head>


<body>
	<div id="mstone">
		<select id="mstone_menu">
			<option value="">- milestone -</option>
		</select>
	</div>
    <div id="bd_chart"></div>
	<div id="loading"><img src="images/loading.gif"/></div>


	<table>
		<tr>
			<td id="as_chart"></td>
			<td id="as_sub_chart" style="float:left;"></td>
		</tr>
	</table>

	<table id="as_table" border="1" align="left">
		<caption>アサインメント回数</caption>
	</table>
	<br><br>
	<table id="at_table" border="1" align="left">
		<caption>タスク実施時間</caption>
	</table>

	<script type='text/javascript'>

	// プロジェクト名を定数化
	//var project = 'trac_legoPrep';
	var project = 'trac_EventSpiral';
var a;
	function drawAssignChart(project) {
		console.log(project, "=");
		if (project == '') {
			return;
		}
		DisplayAssignmentListController.execute(project, {
			callback: function(d) {
a=d;
				var chart_data = createAsData(d);
				var chart = new google.visualization.BarChart(document.getElementById('as_chart'));
				var options = {
					title : 'アサインメント回数 （制約ありタスクのみ）：',
					width : 500,
					height : 500,
					hAxis:{minValue:0, title:'回数', gridlines:{count:-1}},
					legend :{position: 'bottom'},
					chartArea: {width: '70%', height: '70%'},
					//vAxis : {title : '工数（分）'},
					//isHtml : true,
				};
				chart.draw(chart_data, options);

				var chart_sub_data = createAsSubData(d);
				var chart_sub = new google.visualization.BarChart(document.getElementById('as_sub_chart'));
				var options = {
					title : 'アサインメント回数 （制約なしタスクのみ）',
					width : 500,
					height : 500,
					hAxis:{minValue:0, title:'回数', gridlines:{count:-1}},
					legend :{position: 'bottom'},
					chartArea: {width: '70%', height: '70%'},
					//vAxis : {title : '工数（分）'},
					//isHtml : true,
				};
				chart_sub.draw(chart_sub_data, options);
			}
		});

	};

	function createAsData(d) {
		var data = new google.visualization.DataTable();
		data.addColumn('string', '#');
		data.addColumn('number', '作成(ソース)');
		data.addColumn('number', '作成(単体テスト)');
		data.addColumn('number', 'レビュー');

		$('#as_table').append('<thead><tr>'+
				'<th>#</th>'+
				'<th>作成(ソース)</th>'+
				'<th>作成(単体テスト)</th>'+
				'<th>作成(結合テスト)</th>'+
				'<th>レビュー</th>'+
				'<th>バグ修正(ソース)</th>'+
				'<th>バグ修正(単体テスト)</th>'+
				'<th>バグ修正(結合テスト)</th>'+
				'<th>結合テスト</th>'+
				'<th>その他</th>'+
				'</tr></thead><tbody>');
		$('#at_table').append('<thead><tr>'+
				'<th>#</th>'+
				'<th>作成(ソース)</th>'+
				'<th>作成(単体テスト)</th>'+
				'<th>作成(結合テスト)</th>'+
				'<th>レビュー</th>'+
				'<th>バグ修正(ソース)</th>'+
				'<th>バグ修正(単体テスト)</th>'+
				'<th>バグ修正(結合テスト)</th>'+
				'<th>結合テスト</th>'+
				'<th>その他</th>'+
				'</tr></thead><tbody>');
		for (var i=0; i<d.asEntityList.length; i++) {
			var elem = d.asEntityList[i];
			data.addRow([String(elem.owner), elem.createSourceNum, elem.createUTestNum, elem.reviewNum]);

			////
			$('#as_table').append('<tr>' +
				'<td>' + String(elem.owner) + '</td>' +
				'<td>' + elem.createSourceNum + '</td>' +
				'<td>' + elem.createUTestNum + '</td>' +
				'<td>' + elem.createITestNum + '</td>' +
				'<td>' + elem.reviewNum + '</td>' +
				'<td>' + elem.debugSourceNum + '</td>' +
				'<td>' + elem.debugUTestNum + '</td>' +
				'<td>' + elem.debugITestNum + '</td>' +
				'<td>' + elem.iTestNum + '</td>' +
				'<td>' + elem.otherTaskNum + '</td>' +
				'</tr>');

			$('#at_table').append('<tr>' +
				'<td>' + String(elem.owner) + '</td>' +
				'<td>' + elem.createSourceTimeNum + '</td>' +
				'<td>' + elem.createUTestTimeNum + '</td>' +
				'<td>' + elem.createITestTimeNum + '</td>' +
				'<td>' + elem.reviewTimeNum + '</td>' +
				'<td>' + elem.debugSourceTimeNum + '</td>' +
				'<td>' + elem.debugUTestTimeNum + '</td>' +
				'<td>' + elem.debugITestTimeNum + '</td>' +
				'<td>' + elem.iTestTimeNum + '</td>' +
				'<td>' + elem.otherTaskTimeNum + '</td>' +
				'</tr>');
		}
		$('#as_table').append('</tbody>');
		return data;
	};

	function createAsSubData(d) {
		var data = new google.visualization.DataTable();
		data.addColumn('string', '#');
		data.addColumn('number', '作成(結合テスト)');
		data.addColumn('number', 'バグ修正(ソース)');
		data.addColumn('number', 'バグ修正(単体テスト)');
		data.addColumn('number', 'バグ修正(結合テスト)');
		data.addColumn('number', '結合テスト');
		data.addColumn('number', 'その他');
		for (var i=0; i<d.asEntityList.length; i++) {
			var elem = d.asEntityList[i];
			data.addRow([String(elem.owner),
			             elem.createITestNum,
			             elem.debugSourceNum,
			             elem.debugUTEestNum,
			             elem.debugITestNum,
			             elem.iTestNum,
			             elem.otherTaskNum]);
		}
		return data;
	}

	function drawChart(project, milestone) {
		if (milestone == '') {
			return;
		}
		var form = {project:project, milestone:milestone};

		$("#loading").show();
		$("#bd_chart").hide();
		BurnDownChartController.execute(form, {
			callback: function(bdc_data) {
				var chart_data = createBdcData(bdc_data);

				var chart = new google.visualization.ScatterChart(document.getElementById('bd_chart'));
				var options = {
					title : 'バーンダウンチャート：' + milestone,
					width : 800,
					height : 500,
					hAxis : {title : '時間'},
					vAxis : {title : '工数（分）'},
					lineWidth : 1,
					legend : '',
					//isHtml : true,
				};
				chart.draw(chart_data, options);

				$("#loading").fadeOut(function(){
					$("#bd_chart").show();
				});
			},
			exceptionHandler: updateErrorMsg
		})
	};

	function createBdcData(bdc_data) {
		var data = new google.visualization.DataTable();
		data.addColumn('datetime', 'Date');
		data.addColumn('number', '理想');
		data.addColumn('number', '実績');
		data.addRow([bdc_data.idealBeginPoint.elapsedTime, bdc_data.idealBeginPoint.estimatedEffort, null]);
		data.addRow([bdc_data.idealEndPoint.elapsedTime,   bdc_data.idealEndPoint.estimatedEffort,   null]);
		for (var i=0; i<bdc_data.actualPoints.length; i++) {
			data.addRow([bdc_data.actualPoints[i].elapsedTime, null, bdc_data.actualPoints[i].estimatedEffort]);
		}
		return data;
	};

	function dateFormat(d) {
		return d.getHours() + '時' + d.getMinutes() + '分';
	};

	google.load("visualization", "1", {packages:["corechart"]});
	//google.setOnLoadCallback(drawChart);


	// エラーメッセージの更新
	function updateErrorMsg(msg, exc) {
		$('#error_msg').text(msg);
	};

	function createMilestoneList() {
		BurnDownChartController.listMilestones(project, {
			callback: function(data) {
				var buff = $('#mstone_menu').html();
				for (var i=0; i<data.length; i++) {
					buff += '<option value="' + data[i] + '">' + data[i] + '</option>';
				}
				$('#mstone_menu').html(buff);
			},
			exceptionHandler: updateErrorMsg
		})
	};

	$('#mstone_menu').change(function() {
		milestone = $(this).val();
		drawChart(project, milestone);
		stopTimer();
		startTimer();
	});

	$(function() {
		createMilestoneList();
		drawAssignChart(project);
	});



	const REFRESH_INTERVAL = 10*60*1000; //10分間隔でグラフ更新
	const CHECK_INTERVAL = 1000;         //毎秒チェック
	var refreshTimer;

	function startTimer() {
		var prev_updated = new Date();
		refreshTimer = setInterval(function(){
			var remain_ms = REFRESH_INTERVAL - (new Date() - prev_updated);
			var milestone = $('#mstone_menu option:selected').val();
			if (remain_ms < 0) {
				prev_updated = new Date();
				drawChart(project, milestone);
				drawAssignChart(project);
			}
			else if (remain_ms < 60*1000) {
				label = Math.floor(remain_ms/1000) + '秒';
			} else {
				label = Math.floor(remain_ms/(60*1000) + 1) + '分';
			}
//console.log(remain_ms/1000);

			$('svg g text:first').text('バーンダウンチャート：' + milestone + ' （次回更新まで残り' + label + '）');
		}, CHECK_INTERVAL);
	};

	function stopTimer() {
		clearInterval(refreshTimer);
	};
	</script>
</body>

</html>